# Copyright (c) 2023 Contributors to the Eclipse Foundation
#
# See the NOTICE file(s) distributed with this work for additional
# information regarding copyright ownership.
#
# This program and the accompanying materials are made available under the
# terms of the Apache License, Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0. *
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.
#
# * SPDX-License-Identifier: Apache-2.0

name: trace-foss

services:
  postgres:
    image: "postgres:14.4"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./db-init:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_PASSWORD=docker
    expose:
      - "5432"
    networks:
      - tracex-net

  mock-oidc:
    image: ghcr.io/soluto/oidc-server-mock:latest
    ports:
      - '4011:80'
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      SERVER_OPTIONS_INLINE: |
          {
            "AccessTokenJwtType": "JWT",
            "Discovery": {
              "ShowKeySet": true
            }
          }
      LOGIN_OPTIONS_INLINE: |
        {
            "AllowRememberLogin": false
        }
      LOGOUT_OPTIONS_INLINE: |
        {
            "AutomaticRedirectAfterSignOut": true
        }
      API_SCOPES_INLINE: |
        - Name: get-irs-policies
      USERS_CONFIGURATION_INLINE: |
        [
          {
            "SubjectId": "subj_1",
            "Username": "catena-client-1",
            "Password": "password"
          }
        ]
      CLIENTS_CONFIGURATION_INLINE: |
        [
              {
                "ClientId": "catena-client-1",
                "ClientSecrets": ["password"],
                "Description": "Client for client credentials flow",
                "AllowedGrantTypes": ["client_credentials"],
                "AllowedScopes": ["openid", "profile", "email", "get-irs-policies"],
                "ClientClaimsPrefix": "",
                "IdentityTokenLifetime": 86400,
                "AccessTokenLifetime": 86400,
                "Claims": [
                  {
                    "Type": "resource_access",
                    "Value": "{\"Cl20-CX-IRS\": {\"roles\": [\"view_irs\", \"admin_irs\"]}}",
                    "ValueType": "json"
                  },
                  {
                    "Type": "bpn",
                    "Value": "BPNL00000003CRHK",
                    "ValueType": "string"
                  }
                ]
              }
        ]
      ASPNET_SERVICES_OPTIONS_INLINE: |
        {
          "ForwardedHeadersOptions": {
            "ForwardedHeaders" : "All"
          }
        }
    depends_on:
      - postgres
    networks:
      - tracex-net

  # Ref: https://shahar-avigezer.github.io/blog/wiremock/
  # todo: mock IRS API
  irs-mock-server:
    image: wiremock/wiremock:2.32.0
    ports:
      - 3001:8080
    volumes:
      - ./wiremock/irs:/home/wiremock

networks:
  tracex-net:

volumes:
  postgres-data:
